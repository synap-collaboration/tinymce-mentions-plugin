'use strict';var _typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&'function'==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?'symbol':typeof a};(function(a){'use strict';if('object'===('undefined'==typeof exports?'undefined':_typeof(exports))&&'undefined'!=typeof module)module.exports=a(require('jquery'));else if('function'==typeof define&&define.amd)define(['jquery'],a);else{var b;b='undefined'==typeof window?'undefined'==typeof global?'undefined'==typeof self?this:self:global:window,a(b.jQuery)}})(function(a){'use strict';function b(b){var c=b.selection.getRng(!0).startOffset,d=b.selection.getRng(!0).startContainer.data||'',e=d.substr(0<c?c-1:0,1);return!!!a.trim(e).length}function c(c,e,g,h,j,k){var l=a.inArray(e,j.delimiter);if(-1<l&&b(g))void 0!==h&&(void 0===h.hasFocus||h.hasFocus)||(c.preventDefault(),k&&c.stopPropagation(),h=new f(g,a.extend({},j,{delimiter:j.delimiter[l]})));else if(0<d.length){var m=tinymce.activeEditor.selection.getStart(),n=d.some(function(a){return m.attributes&&m.attributes['data-id-'+a]});if(n){for(var o=m.parentNode,p=0,q=0;q<o.childNodes.length;q++)if(o.childNodes[q]===m){p=q;break}var r=tinymce.activeEditor.selection.getRng();0==r.startOffset&&o.childNodes[p]==m?(o.innerHTML='&nbsp;'+o.innerHTML,tinymce.activeEditor.selection.setCursorLocation(o.childNodes[p])):r.endOffset==m.innerHTML.length&&o.childNodes[p]==m?(o.innerHTML+='&nbsp;',tinymce.activeEditor.selection.setCursorLocation(o.childNodes[p+1],1)):c.preventDefault()}}}var d=[],f=function(b,c){this.editor=b,this.beginId=tinymce.DOM.uniqueId(),this.endId=tinymce.DOM.uniqueId(),this.options=a.extend({},{source:[],delay:500,queryBy:'name',items:10},c),this.options.insertFrom=this.options.insertFrom||this.options.queryBy,this.matcher=this.options.matcher||this.matcher,this.sorter=this.options.sorter||this.sorter,this.renderDropdown=this.options.renderDropdown||this.renderDropdown,this.render=this.options.render||this.render,this.insert=this.options.insert||this.insert,this.query='',this.hasFocus=!0,this.renderInput(),this.bindEvents(),this.lookup()};f.prototype={constructor:f,renderInput:function b(){var a='<span id="autocomplete"><span id="autocomplete-delimiter">'+this.options.delimiter+'</span><span id="autocomplete-searchtext"><span class="dummy">\uFEFF</span></span></span>';this.editor.execCommand('mceInsertContent',!1,a),this.editor.focus(),this.editor.selection.select(this.editor.selection.dom.select('span#autocomplete-searchtext span')[0]),this.editor.selection.collapse(0)},bindEvents:function c(){var b=this;this.editor.on('keyup',this.editorKeyUpProxy=a.proxy(this.rteKeyUp,this)),this.editor.on('keydown',this.editorKeyDownProxy=a.proxy(this.rteKeyDown,this),!0),this.editor.on('click',this.editorClickProxy=a.proxy(this.rteClicked,this)),a('body').on('click',this.bodyClickProxy=a.proxy(this.rteLostFocus,this)),a(document).on('mouseenter','li.mentions-menu-suggestion',function(a){b.$dropdown!==void 0&&b.$dropdown.find('li.mentions-menu-suggestion.active').removeClass('active'),'LI'===a.target.nodeName&&a.target.classList.add('active')}),a(this.editor.getWin()).on('scroll',this.rteScroll=a.proxy(function(){this.cleanUp(!0)},this))},unbindEvents:function b(){this.editor.off('keyup',this.editorKeyUpProxy),this.editor.off('keydown',this.editorKeyDownProxy),this.editor.off('click',this.editorClickProxy),a('body').off('click',this.bodyClickProxy),a(this.editor.getWin()).off('scroll',this.rteScroll)},rteKeyUp:function c(a){switch(a.which||a.keyCode){case 40:case 38:case 16:case 17:case 18:break;case 8:''===this.query?this.cleanUp(!0):this.lookup();break;case 9:case 13:var b=this.$dropdown===void 0?[]:this.$dropdown.find('li.active');b.length?(this.select(b.data()),this.cleanUp(!1)):this.cleanUp(!0);break;case 27:this.cleanUp(!0);break;default:this.lookup();}},rteKeyDown:function b(a){switch(a.which||a.keyCode){case 9:case 13:case 27:a.preventDefault();break;case 38:a.preventDefault(),this.$dropdown!==void 0&&this.highlightPreviousResult();break;case 40:a.preventDefault(),this.$dropdown!==void 0&&this.highlightNextResult();}a.stopPropagation()},rteClicked:function d(b){console.log('rteClicked');var c=a(b.target);this.hasFocus&&'autocomplete-searchtext'!==c.parent().attr('id')&&this.cleanUp(!0)},rteLostFocus:function a(){console.log('rteLostFocus'),this.hasFocus&&this.cleanUp(!0)},lookup:function b(){this.query=a.trim(a(this.editor.getBody()).find('#autocomplete-searchtext').text()).replace('\uFEFF',''),this.$dropdown===void 0&&this.show(),clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(a.proxy(function(){var b=a.isFunction(this.options.source)?this.options.source(this.query,a.proxy(this.process,this),this.options.delimiter):this.options.source;b&&this.process(b)},this),this.options.delay)},matcher:function b(a){return~a[this.options.insertFrom].toLowerCase().indexOf(this.query.toLowerCase())},sorter:function f(a){for(var b,c=[],d=[],e=[];(b=a.shift())!==void 0;)b[this.options.insertFrom].toLowerCase().indexOf(this.query.toLowerCase())?~b[this.options.insertFrom].indexOf(this.query)?d.push(b):e.push(b):c.push(b);return c.concat(d,e)},show:function c(){var b=this.editor.inline?this.offsetInline():this.offset();this.$dropdown=a(this.renderDropdown()).css({top:b.top,left:b.left}),a('body').append(this.$dropdown),this.$dropdown.on('click',a.proxy(this.autoCompleteClick,this))},process:function f(b){if(this.hasFocus){var c=this,d=[],e=a.grep(b,function(a){return c.matcher(a)});e=c.sorter(e),e=e.slice(0,this.options.items),a.each(e,function(b,f){var g=a(c.render(f,b));a.each(e[b],function(a,b){g.attr('data-'+a,b)}),d.push(g[0].outerHTML)}),d.length?this.$dropdown.html(d.join('')).show():(this.$dropdown.hide(),this.$dropdown.find('li').removeClass('active')),this.highlightNextResult()}},renderDropdown:function a(){return'<ul class="rte-autocomplete dropdown-menu"><li class="loading"></li></ul>'},render:function b(a){return'<li><a href="javascript:;"><span>'+a[this.options.insertFrom]+'</span></a></li>'},autoCompleteClick:function d(b){var c=a(b.target).closest('li').data();a.isEmptyObject(c)||(this.select(c),this.cleanUp(!1)),b.stopPropagation(),b.preventDefault()},highlightPreviousResult:function c(){var a=this.$dropdown.find('li.active').index(),b=0===a?this.$dropdown.find('li').length-1:--a;this.$dropdown.find('li').removeClass('active').eq(b).addClass('active')},highlightNextResult:function c(){var a=this.$dropdown.find('li.active').index(),b=a===this.$dropdown.find('li').length-1?0:++a;this.$dropdown.find('li').removeClass('active').eq(b).addClass('active')},select:function c(a){this.editor.focus();var b=this.editor.dom.select('span#autocomplete')[0];this.editor.dom.remove(b),d.push(a.id),this.editor.execCommand('mceInsertContent',!1,this.insert(a))},insert:function b(a){return'<span>'+a[this.options.insertFrom]+'</span>&nbsp;'},cleanUp:function g(b){if(console.log('cleanUp'),this.unbindEvents(),this.hasFocus=!1,void 0!==this.$dropdown&&(this.$dropdown.remove(),delete this.$dropdown),b){var c=this.query,d=a(this.editor.dom.select('span#autocomplete'));if(!d.length)return;var e=a('<p>'+this.options.delimiter+c+'</p>')[0].firstChild,f=a(this.editor.selection.getNode()).offset().top===d.offset().top+(d.outerHeight()-d.height())/2;this.editor.dom.replace(e,d[0]),f&&(this.editor.selection.select(e),this.editor.selection.collapse())}},offset:function e(){var b=a(this.editor.getContainer()).offset(),c=a(this.editor.getContentAreaContainer()).position(),d=a(this.editor.dom.select('span#autocomplete')).position();return{top:b.top+c.top+d.top+a(this.editor.selection.getNode()).innerHeight()-a(this.editor.getDoc()).scrollTop()+5,left:b.left+c.left+d.left}},offsetInline:function c(){var b=a(this.editor.dom.select('span#autocomplete')).offset();return{top:b.top+a(this.editor.selection.getNode()).innerHeight()+5,left:b.left}}};tinymce.create('tinymce.plugins.SynapMention',{init:function e(b){var f,g=b.getParam('mentions');g.delimiter=g.delimiter===void 0?['@']:a.isArray(g.delimiter)?g.delimiter:[g.delimiter],b.on('keydown',function(a){switch(a.which||a.keyCode){case 8:var b=tinymce.activeEditor.selection.getRng().startContainer.parentNode;d.some(function(a){if(b.attributes['data-id-'+a])return b.remove(),!0});}}),b.on('keypress',function(a){c(a,String.fromCharCode(a.which||a.keyCode),b,f,g)}),b.addButton('mention-button',{title:'@',text:'@',onClick:function d(a){c(a,'@',b,f,g,!0)}})},getInfo:function a(){return{longname:'synap-mention',author:'Jesse Cooper',version:tinymce.majorVersion+'.'+tinymce.minorVersion}}}),tinymce.PluginManager.add('synap-mention',tinymce.plugins.SynapMention)});
